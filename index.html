<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paystub Generator Pro - Buell Docs</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lexend:wght@400;500;600&display=swap" rel="stylesheet">
    <!-- The html2pdf.js library is used for the PDF generation functionality -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" xintegrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        /* Modern CSS Reset */
        *, *::before, *::after { box-sizing: border-box; }
        * { margin: 0; }
        html, body { height: 100%; }
        body { line-height: 1.6; -webkit-font-smoothing: antialiased; }
        img, picture, video, canvas, svg { display: block; max-width: 100%; }
        input, button, textarea, select { font: inherit; }
        p, h1, h2, h3, h4, h5, h6 { overflow-wrap: break-word; }

        /* Custom Properties for a Modern Theme */
        :root {
            --primary-color: #0052cc; /* A deeper, more professional blue */
            --primary-light: #e6f0ff;
            --secondary-color: #172b4d; /* Dark slate blue for text */
            --accent-color: #4cceac; /* A vibrant teal/green for accents */
            --background-color: #f4f5f7; /* Lighter, cleaner background */
            --white-color: #ffffff;
            --border-color: #dfe1e6;
            --shadow-color-light: rgba(9, 30, 66, 0.08);
            --shadow-color-medium: rgba(9, 30, 66, 0.15);
            --text-color: #42526e; /* Softer text color */
            --heading-color: #172b4d;
            --danger-color: #de350b;
        }

        /* General Body Styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            font-size: 15px;
        }

        /* Main App Container and Layout */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 24px;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 1fr;
            gap: 24px;
        }

        @media (min-width: 1024px) {
            .main-layout {
                grid-template-columns: 480px 1fr;
            }
        }

        /* Header Styles */
        .header {
            background: var(--white-color);
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px var(--shadow-color-light);
            border-radius: 8px;
            margin-bottom: 24px;
        }

        .header .logo {
            font-family: 'Lexend', sans-serif;
            font-size: 1.75rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        /* Card styles for form and preview */
        .card {
            background: var(--white-color);
            padding: 28px;
            border-radius: 12px;
            box-shadow: 0 4px 12px var(--shadow-color-light);
            height: fit-content;
        }

        .card-header {
            padding: 20px 28px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-header h2 { margin: 0; font-family: 'Lexend', sans-serif; font-size: 1.5rem; }

        /* Form Styles */
        .form-section h3 {
            font-family: 'Lexend', sans-serif;
            color: var(--heading-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            margin-top: 24px;
            margin-bottom: 20px;
            font-size: 1.2rem;
        }
        .form-section h3:first-child { margin-top: 0; }

        .form-group { margin-bottom: 20px; }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: var(--heading-color);
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--white-color);
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px var(--primary-light);
        }
        
        .disclaimer {
            padding: 12px;
            background-color: var(--primary-light);
            border-left: 4px solid var(--primary-color);
            font-size: 0.9em;
            margin: 15px 0;
            border-radius: 4px;
        }

        /* Button Styles */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 24px;
            border-radius: 6px;
            border: 1px solid transparent;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: var(--white-color);
            border-color: var(--primary-color);
        }
        .btn-primary:hover {
            background-color: #0041a3;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px var(--shadow-color-medium);
        }

        .btn-secondary {
            background-color: var(--primary-light);
            color: var(--primary-color);
            width: 100%;
            margin-top: 10px;
        }
        .btn-secondary:hover { background-color: #d9e7ff; }

        /* Dynamic Fields (Earnings/Deductions) */
        .dynamic-field-group { display: flex; flex-direction: column; gap: 10px; }
        .dynamic-field { display: flex; gap: 10px; align-items: center; }
        .dynamic-field input { flex: 1; }
        .dynamic-field-grid { display: grid; grid-template-columns: 1fr 100px 100px 30px; gap: 10px; align-items: center;}
        
        .btn-remove {
            background: none; border: none; color: var(--danger-color); cursor: pointer;
            width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 1.2rem;
        }

        /* Preview Area */
        .preview-nav { display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 20px; }
        .preview-nav-status { font-weight: 600; color: var(--heading-color); }

        #previews-container .paystub-wrapper { display: none; }
        #previews-container .paystub-wrapper.active { display: block; }
        
        #paystub-template {
            padding: 30px;
            font-size: 14px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }

        .paystub-header { text-align: center; margin-bottom: 25px; }
        .paystub-header h3 { margin: 0 0 4px 0; font-size: 26px; color: var(--heading-color); }
        .paystub-header p { margin: 2px 0; font-size: 14px; }
        .paystub-header .statement-title { font-weight: 700; font-size: 1rem; letter-spacing: 1px; color: var(--text-color); margin-top: 8px; }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            padding: 15px;
            background-color: #f9fafb;
            border-radius: 8px;
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
        }
        .info-grid div { font-size: 14px; }
        .info-grid strong { display: block; color: #555; margin-bottom: 4px; font-weight: 600; }
        
        .tables-grid { display: grid; grid-template-columns: 1fr; gap: 24px; }
        @media (min-width: 600px) {
            .tables-grid { grid-template-columns: repeat(2, 1fr); }
            #earnings-section { grid-column: 1 / -1; }
        }

        .paystub-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .paystub-table caption { font-size: 1.2rem; font-weight: 600; text-align: left; padding-bottom: 10px; color: var(--heading-color); }
        .paystub-table th, .paystub-table td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .paystub-table thead th { background-color: #f9fafb; font-weight: 600; font-size: 0.85rem; color: var(--text-color); }
        .paystub-table .text-right { text-align: right; }
        .paystub-table tfoot td { font-weight: 700; background-color: #f9fafb; }

        .paystub-summary {
            background-color: var(--secondary-color);
            color: var(--white-color);
            padding: 20px;
            border-radius: 8px;
            margin-top: 25px;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            text-align: center;
        }
        .summary-item strong { display: block; font-size: 14px; opacity: 0.9; margin-bottom: 5px; }
        .summary-item span { font-size: 18px; font-weight: 600; }
        #net-pay-display { font-size: 24px; font-weight: 700; color: var(--accent-color); }

        /* Footer */
        .footer { text-align: center; margin-top: 30px; padding: 20px; color: #8894a7; font-size: 0.9rem; }
        .footer a { color: var(--primary-color); text-decoration: none; }
    </style>
</head>

<body>

    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo">Buell Docs</div>
            <!-- Future Nav Links Here -->
        </header>

        <!-- Main Content Layout -->
        <main class="main-layout">
            <!-- Form Section -->
            <aside class="card form-section">
                <form id="paystub-form">
                    
                    <!-- Income Calculator -->
                    <section>
                        <h3>Income Calculator</h3>
                        <div class="form-group">
                            <label for="incomeType">Calculate Pay From</label>
                            <select id="incomeType" name="incomeType">
                                <option value="manual" selected>Manual Entry Below</option>
                                <option value="annual">Annual Salary</option>
                                <option value="monthly">Monthly Salary</option>
                                <option value="weekly">Weekly Salary</option>
                            </select>
                        </div>
                         <div class="form-group" id="income-amount-group" style="display: none;">
                            <label for="incomeAmount">Amount</label>
                            <input type="number" id="incomeAmount" name="incomeAmount" placeholder="e.g., 65000" step="0.01">
                        </div>
                        <div class="disclaimer">
                            <strong>Disclaimer:</strong> This tool calculates gross pay. The final net pay will be lower after taxes and other deductions are withheld.
                        </div>
                    </section>
                    
                    <!-- Batch Generation -->
                    <section>
                         <h3>Batch Generation</h3>
                         <div class="form-group">
                             <label for="numPaystubs">Number of Paystubs to Generate (1-8)</label>
                             <input type="number" id="numPaystubs" name="numPaystubs" min="1" max="8" value="1">
                         </div>
                         <div id="paystub-dates-container">
                             <!-- Paystub date inputs will be generated here by JS -->
                         </div>
                    </section>

                    <!-- Business Information -->
                    <section>
                        <h3>Business Information</h3>
                        <div class="form-group"><label for="businessName">Business Name</label><input type="text" id="businessName" value="Buell Industries, Inc."></div>
                        <div class="form-group"><label for="businessAddress">Business Address</label><input type="text" id="businessAddress" value="123 Innovation Drive, Tech City, 54321"></div>
                        <div class="form-group"><label for="businessEin">Company EIN/FEIN</label><input type="text" id="businessEin" placeholder="XX-XXXXXXX" value="12-3456789"></div>
                    </section>

                    <!-- Employee Information -->
                    <section>
                        <h3>Employee Information</h3>
                        <div class="form-group"><label for="employeeName">Employee Name</label><input type="text" id="employeeName" value="Jane Doe"></div>
                        <div class="form-group"><label for="employeeAddress">Employee Address</label><input type="text" id="employeeAddress" value="456 Home Street, Suburbia, 12345"></div>
                        <div class="form-group"><label for="employeeId">Employee ID</label><input type="text" id="employeeId" value="EMP-007"></div>
                        <div class="form-group"><label for="employeeSsn">SSN (Optional, Last 4)</label><input type="text" id="employeeSsn" placeholder="XXX-XX-1234" value="XXX-XX-5678"></div>
                    </section>
                    
                    <!-- Pay Details -->
                     <section>
                        <h3>Pay Details</h3>
                         <div class="form-group">
                            <label for="payPeriod">Pay Frequency</label>
                            <select id="payPeriod" name="payPeriod">
                                <option value="weekly">Weekly</option>
                                <option value="bi-weekly" selected>Bi-Weekly</option>
                                <option value="semi-monthly">Semi-monthly</option>
                                <option value="monthly">Monthly</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="payRate">Pay Rate (per hour or salary per pay period)</label>
                            <input type="number" id="payRate" name="payRate" step="0.01" value="31.25">
                        </div>
                    </section>


                    <!-- Earnings -->
                    <section>
                        <h3>Earnings</h3>
                        <div class="dynamic-field-group" id="earnings-container">
                             <div class="form-group dynamic-field-grid">
                                <label style="margin-bottom: 0;">Description</label>
                                <label style="margin-bottom: 0;">Rate</label>
                                <label style="margin-bottom: 0;">Hours</label>
                                <span></span>
                            </div>
                        </div>
                        <button type="button" id="add-earning" class="btn btn-secondary">+ Add Earning</button>
                    </section>
                    
                    <!-- Deductions -->
                     <section>
                        <h3>Deductions</h3>
                        <div class="dynamic-field-group" id="deductions-container">
                             <div class="form-group dynamic-field-grid">
                                <label style="margin-bottom: 0;">Description</label>
                                <label style="margin-bottom: 0;">Current</label>
                                <label style="margin-bottom: 0;">YTD</label>
                                <span></span>
                            </div>
                        </div>
                        <button type="button" id="add-deduction" class="btn btn-secondary">+ Add Deduction</button>
                    </section>

                    <!-- Tax Information -->
                    <section>
                        <h3>Tax Information</h3>
                        <div class="form-group">
                            <label for="taxYear">Tax Year</label>
                            <select id="taxYear" name="taxYear">
                                <option value="2025">2025</option>
                                <option value="2024" selected>2024</option>
                                <option value="2023">2023</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="filingStatus">Federal Filing Status</label>
                            <select id="filingStatus" name="filingStatus">
                                <option value="single">Single</option>
                                <option value="married">Married Filing Jointly</option>
                                <option value="hoh">Head of Household</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="state">State</label>
                            <select id="state" name="state"><!-- States will be populated by JS --></select>
                        </div>
                    </section>
                </form>
            </aside>

            <!-- Preview Section -->
            <section class="preview-section-wrapper">
                <div class="card-header">
                    <h2>Paystub Preview</h2>
                    <button id="download-pdf" class="btn btn-primary">Download PDF</button>
                </div>
                <div class="card">
                     <div class="preview-nav">
                        <button id="prev-stub" class="btn">&lt; Previous</button>
                        <span id="stub-nav-status" class="preview-nav-status">Stub 1 of 1</span>
                        <button id="next-stub" class="btn">Next &gt;</button>
                    </div>
                    <div id="previews-container">
                         <!-- Paystub previews will be generated here by JS -->
                    </div>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <p>&copy; 2025 Paystub Generator Pro. A <a href="#">Buell Docs</a> creation.</p>
        </footer>
    </div>
    
    <!-- This is a hidden template that will be cloned for each paystub -->
    <div id="paystub-template" style="display: none;">
        <div class="paystub-header">
            <h3 data-id="businessName"></h3>
            <p data-id="businessAddress"></p>
            <p data-id="businessEin"></p>
            <p class="statement-title">EARNINGS STATEMENT</p>
        </div>

        <div class="info-grid">
            <div>
                <strong>Employee:</strong>
                <span data-id="employeeName"></span><br>
                <span data-id="employeeAddress"></span>
            </div>
            <div>
                <strong>Employee ID:</strong> <span data-id="employeeId"></span><br>
                <strong>SSN:</strong> <span data-id="employeeSsn"></span><br>
                <strong>Pay Date:</strong> <span data-id="payDate"></span><br>
                <strong>Pay Period:</strong> <span data-id="payPeriodRange"></span>
            </div>
        </div>
        
        <div class="tables-grid">
            <div id="earnings-section">
                <table class="paystub-table" data-id="earnings-table">
                    <caption>Earnings</caption>
                    <thead><tr><th>Description</th><th class="text-right">Rate</th><th class="text-right">Hours</th><th class="text-right">Current</th><th class="text-right">YTD</th></tr></thead>
                    <tbody></tbody>
                    <tfoot><tr><td colspan="4">Gross Pay</td><td class="text-right" data-id="grossPay"></td></tr></tfoot>
                </table>
            </div>

            <div>
                 <table class="paystub-table" data-id="deductions-table">
                    <caption>Deductions</caption>
                    <thead><tr><th>Description</th><th class="text-right">Current</th><th class="text-right">YTD</th></tr></thead>
                    <tbody></tbody>
                    <tfoot><tr><td>Total Deductions</td><td class="text-right" data-id="totalDeductions"></td><td></td></tr></tfoot>
                </table>
            </div>

            <div>
                 <table class="paystub-table" data-id="taxes-table">
                    <caption>Taxes</caption>
                    <thead><tr><th>Description</th><th class="text-right">Current</th><th class="text-right">YTD</th></tr></thead>
                    <tbody></tbody>
                    <tfoot><tr><td>Total Taxes</td><td class="text-right" data-id="totalTaxes"></td><td></td></tr></tfoot>
                </table>
            </div>
        </div>

        <div class="paystub-summary">
            <div class="summary-grid">
                 <div class="summary-item"><strong>Gross Pay</strong><span data-id="summary-grossPay">$0.00</span></div>
                 <div class="summary-item"><strong>Total Deductions</strong><span data-id="summary-totalDeductions">$0.00</span></div>
                 <div class="summary-item"><strong>Total Taxes</strong><span data-id="summary-totalTaxes">$0.00</span></div>
                 <div class="summary-item"><strong>Net Pay</strong><span id="net-pay-display" data-id="summary-netPay">$0.00</span></div>
            </div>
        </div>
    </div>

    <script>
    // This script combines all the necessary JavaScript modules into one file.
    (function() {
        'use strict';

        const BuellDocsApp = {};

        // --- DATA STORE ---
        // Prevents the need for network requests
        const taxTablesData = {
            "2023": {"federal": {"single": {"brackets": [{"rate": 0.10, "upto": 11000}, {"rate": 0.12, "upto": 44725}, {"rate": 0.22, "upto": 95375}, {"rate": 0.24, "upto": 182100}, {"rate": 0.32, "upto": 231250}, {"rate": 0.35, "upto": 578125}, {"rate": 0.37, "upto": Infinity}], "deduction": 13850}, "married": {"brackets": [{"rate": 0.10, "upto": 22000}, {"rate": 0.12, "upto": 89450}, {"rate": 0.22, "upto": 190750}, {"rate": 0.24, "upto": 364200}, {"rate": 0.32, "upto": 462500}, {"rate": 0.35, "upto": 693750}, {"rate": 0.37, "upto": Infinity}], "deduction": 27700}, "hoh": {"brackets": [{"rate": 0.10, "upto": 15700}, {"rate": 0.12, "upto": 59850}, {"rate": 0.22, "upto": 95350}, {"rate": 0.24, "upto": 182100}, {"rate": 0.32, "upto": 231250}, {"rate": 0.35, "upto": 578100}, {"rate": 0.37, "upto": Infinity}], "deduction": 20800}}, "fica": {"social_security_rate": 0.062, "social_security_limit": 160200, "medicare_rate": 0.0145}},
            "2024": {"federal": {"single": {"brackets": [{"rate": 0.10, "upto": 11600}, {"rate": 0.12, "upto": 47150}, {"rate": 0.22, "upto": 100525}, {"rate": 0.24, "upto": 191950}, {"rate": 0.32, "upto": 243725}, {"rate": 0.35, "upto": 609350}, {"rate": 0.37, "upto": Infinity}], "deduction": 14600}, "married": {"brackets": [{"rate": 0.10, "upto": 23200}, {"rate": 0.12, "upto": 94300}, {"rate": 0.22, "upto": 201050}, {"rate": 0.24, "upto": 383900}, {"rate": 0.32, "upto": 487450}, {"rate": 0.35, "upto": 731200}, {"rate": 0.37, "upto": Infinity}], "deduction": 29200}, "hoh": {"brackets": [{"rate": 0.10, "upto": 16550}, {"rate": 0.12, "upto": 63100}, {"rate": 0.22, "upto": 100500}, {"rate": 0.24, "upto": 191950}, {"rate": 0.32, "upto": 243700}, {"rate": 0.35, "upto": 609350}, {"rate": 0.37, "upto": Infinity}], "deduction": 21900}}, "fica": {"social_security_rate": 0.062, "social_security_limit": 168600, "medicare_rate": 0.0145}, "states": {"AL": {"name": "Alabama", "single": {"brackets": [{"rate": 0.02, "upto": 500}, {"rate": 0.04, "upto": 3000}, {"rate": 0.05, "upto": Infinity}]}}, "AK": {"name": "Alaska", "single": {"brackets": []}}, "AZ": {"name": "Arizona", "single": {"brackets": [{"rate": 0.025, "upto": Infinity}]}}, "AR": {"name": "Arkansas", "single": {"brackets": [{"rate": 0.02, "upto": 24299}, {"rate": 0.04, "upto": 87000}, {"rate": 0.049, "upto": Infinity}]}}, "CA": {"name": "California", "single": {"brackets": [{"rate": 0.01, "upto": 10412}, {"rate": 0.02, "upto": 24684}, {"rate": 0.04, "upto": 38959}, {"rate": 0.06, "upto": 54081}, {"rate": 0.08, "upto": 68350}, {"rate": 0.093, "upto": 349137}, {"rate": 0.103, "upto": 418961}, {"rate": 0.113, "upto": 698271}, {"rate": 0.123, "upto": Infinity}]}}, "CO": {"name": "Colorado", "single": {"brackets": [{"rate": 0.044, "upto": Infinity}]}}, "CT": {"name": "Connecticut", "single": {"brackets": [{"rate": 0.03, "upto": 10000}, {"rate": 0.05, "upto": 50000}, {"rate": 0.055, "upto": 100000}, {"rate": 0.06, "upto": 200000}, {"rate": 0.065, "upto": 250000}, {"rate": 0.069, "upto": 500000}, {"rate": 0.0699, "upto": Infinity}]}}, "DE": {"name": "Delaware", "single": {"brackets": [{"rate": 0.022, "upto": 5000}, {"rate": 0.039, "upto": 10000}, {"rate": 0.048, "upto": 20000}, {"rate": 0.052, "upto": 25000}, {"rate": 0.0555, "upto": 60000}, {"rate": 0.066, "upto": Infinity}]}}, "FL": {"name": "Florida", "single": {"brackets": []}}, "GA": {"name": "Georgia", "single": {"brackets": [{"rate": 0.0549, "upto": Infinity}]}}, "HI": {"name": "Hawaii", "single": {"brackets": [{"rate": 0.014, "upto": 2400}, {"rate": 0.032, "upto": 4800}, {"rate": 0.055, "upto": 9600}, {"rate": 0.064, "upto": 14400}, {"rate": 0.068, "upto": 19200}, {"rate": 0.072, "upto": 24000}, {"rate": 0.076, "upto": 36000}, {"rate": 0.079, "upto": 48000}, {"rate": 0.0825, "upto": 150000}, {"rate": 0.09, "upto": 175000}, {"rate": 0.1, "upto": 200000}, {"rate": 0.11, "upto": Infinity}]}}, "ID": {"name": "Idaho", "single": {"brackets": [{"rate": 0.058, "upto": Infinity}]}}, "IL": {"name": "Illinois", "single": {"brackets": [{"rate": 0.0495, "upto": Infinity}]}}, "IN": {"name": "Indiana", "single": {"brackets": [{"rate": 0.0315, "upto": Infinity}]}}, "IA": {"name": "Iowa", "single": {"brackets": [{"rate": 0.057, "upto": Infinity}]}}, "KS": {"name": "Kansas", "single": {"brackets": [{"rate": 0.031, "upto": 15000}, {"rate": 0.0525, "upto": 30000}, {"rate": 0.057, "upto": Infinity}]}}, "KY": {"name": "Kentucky", "single": {"brackets": [{"rate": 0.045, "upto": Infinity}]}}, "LA": {"name": "Louisiana", "single": {"brackets": [{"rate": 0.0185, "upto": 12500}, {"rate": 0.037, "upto": 50000}, {"rate": 0.0425, "upto": Infinity}]}}, "ME": {"name": "Maine", "single": {"brackets": [{"rate": 0.058, "upto": 24500}, {"rate": 0.0675, "upto": 58050}, {"rate": 0.0715, "upto": Infinity}]}}, "MD": {"name": "Maryland", "single": {"brackets": [{"rate": 0.02, "upto": 1000}, {"rate": 0.03, "upto": 2000}, {"rate": 0.04, "upto": 3000}, {"rate": 0.0475, "upto": 100000}, {"rate": 0.05, "upto": 125000}, {"rate": 0.0525, "upto": 150000}, {"rate": 0.055, "upto": 250000}, {"rate": 0.0575, "upto": Infinity}]}}, "MA": {"name": "Massachusetts", "single": {"brackets": [{"rate": 0.05, "upto": Infinity}]}}, "MI": {"name": "Michigan", "single": {"brackets": [{"rate": 0.0425, "upto": Infinity}]}}, "MN": {"name": "Minnesota", "single": {"brackets": [{"rate": 0.0535, "upto": 30070}, {"rate": 0.068, "upto": 98750}, {"rate": 0.0785, "upto": 183340}, {"rate": 0.0985, "upto": Infinity}]}}, "MS": {"name": "Mississippi", "single": {"brackets": [{"rate": 0.04, "upto": 5000}, {"rate": 0.05, "upto": Infinity}]}}, "MO": {"name": "Missouri", "single": {"brackets": [{"rate": 0.0495, "upto": Infinity}]}}, "MT": {"name": "Montana", "single": {"brackets": [{"rate": 0.047, "upto": 20500}, {"rate": 0.059, "upto": Infinity}]}}, "NE": {"name": "Nebraska", "single": {"brackets": [{"rate": 0.0246, "upto": 3220}, {"rate": 0.0351, "upto": 19340}, {"rate": 0.0501, "upto": 32230}, {"rate": 0.0664, "upto": Infinity}]}}, "NV": {"name": "Nevada", "single": {"brackets": []}}, "NH": {"name": "New Hampshire", "single": {"brackets": []}}, "NJ": {"name": "New Jersey", "single": {"brackets": [{"rate": 0.014, "upto": 20000}, {"rate": 0.0175, "upto": 35000}, {"rate": 0.035, "upto": 40000}, {"rate": 0.05525, "upto": 75000}, {"rate": 0.0637, "upto": 500000}, {"rate": 0.0897, "upto": 1000000}, {"rate": 0.1075, "upto": Infinity}]}}, "NM": {"name": "New Mexico", "single": {"brackets": [{"rate": 0.017, "upto": 5500}, {"rate": 0.032, "upto": 11000}, {"rate": 0.049, "upto": 16000}, {"rate": 0.059, "upto": Infinity}]}}, "NY": {"name": "New York", "single": {"brackets": [{"rate": 0.04, "upto": 8500}, {"rate": 0.045, "upto": 11700}, {"rate": 0.0525, "upto": 13900}, {"rate": 0.055, "upto": 80650}, {"rate": 0.06, "upto": 215400}, {"rate": 0.0685, "upto": 1077550}, {"rate": 0.0965, "upto": 5000000}, {"rate": 0.103, "upto": 25000000}, {"rate": 0.109, "upto": Infinity}]}}, "NC": {"name": "North Carolina", "single": {"brackets": [{"rate": 0.0475, "upto": Infinity}]}}, "ND": {"name": "North Dakota", "single": {"brackets": [{"rate": 0.011, "upto": 44725}, {"rate": 0.0204, "upto": 90425}, {"rate": 0.0227, "upto": 222525}, {"rate": 0.0264, "upto": 473975}, {"rate": 0.029, "upto": Infinity}]}}, "OH": {"name": "Ohio", "single": {"brackets": [{"rate": 0.02765, "upto": 26050}, {"rate": 0.03226, "upto": 100000}, {"rate": 0.03688, "upto": Infinity}]}}, "OK": {"name": "Oklahoma", "single": {"brackets": [{"rate": 0.005, "upto": 1000}, {"rate": 0.01, "upto": 2500}, {"rate": 0.02, "upto": 3750}, {"rate": 0.03, "upto": 4900}, {"rate": 0.04, "upto": 7200}, {"rate": 0.0475, "upto": Infinity}]}}, "OR": {"name": "Oregon", "single": {"brackets": [{"rate": 0.0475, "upto": 3750}, {"rate": 0.0675, "upto": 9450}, {"rate": 0.0875, "upto": 125000}, {"rate": 0.099, "upto": Infinity}]}}, "PA": {"name": "Pennsylvania", "single": {"brackets": [{"rate": 0.0307, "upto": Infinity}]}}, "RI": {"name": "Rhode Island", "single": {"brackets": [{"rate": 0.0375, "upto": 68250}, {"rate": 0.0475, "upto": 155050}, {"rate": 0.0599, "upto": Infinity}]}}, "SC": {"name": "South Carolina", "single": {"brackets": [{"rate": 0.03, "upto": 3210}, {"rate": 0.065, "upto": Infinity}]}}, "SD": {"name": "South Dakota", "single": {"brackets": []}}, "TN": {"name": "Tennessee", "single": {"brackets": []}}, "TX": {"name": "Texas", "single": {"brackets": []}}, "UT": {"name": "Utah", "single": {"brackets": [{"rate": 0.0465, "upto": Infinity}]}}, "VT": {"name": "Vermont", "single": {"brackets": [{"rate": 0.0335, "upto": 45300}, {"rate": 0.066, "upto": 109800}, {"rate": 0.076, "upto": 229300}, {"rate": 0.0875, "upto": Infinity}]}}, "VA": {"name": "Virginia", "single": {"brackets": [{"rate": 0.02, "upto": 3000}, {"rate": 0.03, "upto": 5000}, {"rate": 0.05, "upto": 17000}, {"rate": 0.0575, "upto": Infinity}]}}, "WA": {"name": "Washington", "single": {"brackets": []}}, "WV": {"name": "West Virginia", "single": {"brackets": [{"rate": 0.0236, "upto": 10000}, {"rate": 0.0315, "upto": 25000}, {"rate": 0.0354, "upto": 40000}, {"rate": 0.0472, "upto": 60000}, {"rate": 0.0512, "upto": Infinity}]}}, "WI": {"name": "Wisconsin", "single": {"brackets": [{"rate": 0.0354, "upto": 13600}, {"rate": 0.0465, "upto": 27210}, {"rate": 0.053, "upto": 300090}, {"rate": 0.0765, "upto": Infinity}]}}, "WY": {"name": "Wyoming", "single": {"brackets": []}}}},
            "2025": {"federal": {"single": {"brackets": [{"rate": 0.10, "upto": 12000}, {"rate": 0.12, "upto": 48500}, {"rate": 0.22, "upto": 103500}, {"rate": 0.24, "upto": 197500}, {"rate": 0.32, "upto": 250000}, {"rate": 0.35, "upto": 625000}, {"rate": 0.37, "upto": Infinity}], "deduction": 15000}, "married": {"brackets": [{"rate": 0.10, "upto": 24000}, {"rate": 0.12, "upto": 97000}, {"rate": 0.22, "upto": 207000}, {"rate": 0.24, "upto": 395000}, {"rate": 0.32, "upto": 500000}, {"rate": 0.35, "upto": 750000}, {"rate": 0.37, "upto": Infinity}], "deduction": 30000}, "hoh": {"brackets": [{"rate": 0.10, "upto": 17000}, {"rate": 0.12, "upto": 65000}, {"rate": 0.22, "upto": 103500}, {"rate": 0.24, "upto": 197500}, {"rate": 0.32, "upto": 250000}, {"rate": 0.35, "upto": 625000}, {"rate": 0.37, "upto": Infinity}], "deduction": 22500}}, "fica": {"social_security_rate": 0.062, "social_security_limit": 175000, "medicare_rate": 0.0145}, "states": taxTablesData["2024"].states }
        };

        // --- UTILS ---
        const pMath = {
            add: (...nums) => nums.reduce((a, b) => a + b, 0),
            subtract: (a, b) => a - b,
            multiply: (a, b) => a * b,
            divide: (a, b) => (b === 0 ? 0 : a / b),
            round: (num) => Math.round(num * 100) / 100
        };
        BuellDocsApp.pMath = pMath;

        const formatDate = (dateString) => {
            if (!dateString) return '';
            const date = new Date(dateString + 'T00:00:00'); // Treat as local time
            return date.toLocaleDateString('en-US', { year: 'numeric', month: '2-digit', day: '2-digit' });
        };
        
        const formatCurrency = (amount) => `$${(amount || 0).toFixed(2)}`;

        // --- DATA SERVICE ---
        class DataService {
            getTaxTables(year) { return Promise.resolve(taxTablesData[year] || null); }
            getAllStateNames() {
                const yearData = taxTablesData['2024'];
                if (!yearData || !yearData.states) return {};
                const states = {};
                for (const abbr in yearData.states) {
                    states[abbr] = yearData.states[abbr].name;
                }
                return states;
            }
        }
        BuellDocsApp.DataService = DataService;

        // --- PAYSTUB CALCULATOR ---
        class PaystubCalculator {
            constructor() {
                this.dataService = new BuellDocsApp.DataService();
            }

            async calculateAll(baseFormData) {
                const results = [];
                const taxTables = await this.dataService.getTaxTables(baseFormData.taxYear);
                if (!taxTables) throw new Error(`Tax info for ${baseFormData.taxYear} not found.`);

                let ytdEarningsTracker = { ...baseFormData.initialYtd.earnings };
                let ytdDeductionsTracker = { ...baseFormData.initialYtd.deductions };
                let ytdTaxesTracker = { ...baseFormData.initialYtd.taxes };


                for (let i = 0; i < baseFormData.numPaystubs; i++) {
                    const singleStubData = { ...baseFormData, ...baseFormData.stubs[i] };
                    const result = this.calculateSingle(singleStubData, taxTables, ytdEarningsTracker, ytdDeductionsTracker, ytdTaxesTracker);
                    
                    // Update YTD trackers for the next iteration
                    result.earnings.forEach(e => ytdEarningsTracker[e.description] = pMath.add(ytdEarningsTracker[e.description] || 0, e.current));
                    result.deductions.forEach(d => ytdDeductionsTracker[d.description] = pMath.add(ytdDeductionsTracker[d.description] || 0, d.current));
                    result.taxes.forEach(t => ytdTaxesTracker[t.name] = pMath.add(ytdTaxesTracker[t.name] || 0, t.current));

                    results.push(result);
                }
                return results;
            }

            calculateSingle(formData, taxTables, ytdEarnings, ytdDeductions, ytdTaxes) {
                const payPeriodsPerYear = { weekly: 52, 'bi-weekly': 26, 'semi-monthly': 24, monthly: 12 };
                const numPayPeriods = payPeriodsPerYear[formData.payPeriod] || 26;
                
                // Calculate current gross pay based on earnings input
                const currentGrossPay = formData.earnings.reduce((total, item) => pMath.add(total, item.current), 0);
                const annualGross = pMath.multiply(currentGrossPay, numPayPeriods);

                const calculatedTaxes = this.calculateTaxes(currentGrossPay, annualGross, formData, taxTables, numPayPeriods, ytdEarnings);

                const currentTotalDeductions = formData.deductions.reduce((total, item) => pMath.add(total, item.current), 0);
                const currentTotalTaxes = Object.values(calculatedTaxes).reduce((sum, tax) => pMath.add(sum, tax), 0);
                const netPay = pMath.subtract(pMath.subtract(currentGrossPay, currentTotalTaxes), currentTotalDeductions);

                return {
                    ...formData,
                    grossPay: currentGrossPay,
                    netPay,
                    totalDeductions: currentTotalDeductions,
                    totalTaxes: currentTotalTaxes,
                    // Map earnings, deductions, and taxes to include updated YTD values
                    earnings: formData.earnings.map(e => ({...e, ytd: pMath.add(ytdEarnings[e.description] || 0, e.current)})),
                    deductions: formData.deductions.map(d => ({...d, ytd: pMath.add(ytdDeductions[d.description] || 0, d.current)})),
                    taxes: [
                        { name: 'Federal Income Tax', current: calculatedTaxes.federal, ytd: pMath.add(ytdTaxes['Federal Income Tax'] || 0, calculatedTaxes.federal) },
                        { name: 'Social Security', current: calculatedTaxes.socialSecurity, ytd: pMath.add(ytdTaxes['Social Security'] || 0, calculatedTaxes.socialSecurity) },
                        { name: 'Medicare', current: calculatedTaxes.medicare, ytd: pMath.add(ytdTaxes['Medicare'] || 0, calculatedTaxes.medicare) },
                        { name: 'State Income Tax', current: calculatedTaxes.state, ytd: pMath.add(ytdTaxes['State Income Tax'] || 0, calculatedTaxes.state) },
                    ].filter(t => t.current > 0 || t.ytd > 0), // Only show taxes if they have a value
                };
            }
            
            calculateTaxes(currentGross, annualGross, formData, taxTables, numPayPeriods, ytdEarnings) {
                // Sum all YTD earnings to get total YTD gross for FICA limit checking
                const totalYtdGross = Object.values(ytdEarnings).reduce((sum, val) => sum + val, 0);
                const federal = this.getFederalTax(annualGross, formData.filingStatus, taxTables.federal, numPayPeriods);
                const socialSecurity = this.getSocialSecurityTax(currentGross, totalYtdGross, taxTables.fica);
                const medicare = this.getMedicareTax(currentGross, taxTables.fica);
                const state = this.getStateTax(annualGross, formData.state, formData.filingStatus, taxTables.states, numPayPeriods);
                return { federal, socialSecurity, medicare, state };
            }

            // Generic function to calculate tax based on progressive brackets
            calculateBracketTax(annualIncome, taxInfo) {
                let tax = 0;
                let lastUpto = 0;
                for (const bracket of taxInfo.brackets) {
                    if (annualIncome > lastUpto) {
                        const taxableInBracket = Math.min(annualIncome, bracket.upto) - lastUpto;
                        tax += pMath.multiply(taxableInBracket, bracket.rate);
                    }
                    lastUpto = bracket.upto;
                }
                return tax;
            }

            // Calculates Federal Income Tax
            getFederalTax(annualGross, filingStatus, federalTables, numPayPeriods) {
                const table = federalTables[filingStatus];
                if (!table) return 0;
                const taxableIncome = Math.max(0, pMath.subtract(annualGross, table.deduction)); // Deduct standard deduction
                const annualTax = this.calculateBracketTax(taxableIncome, table);
                return pMath.round(pMath.divide(annualTax, numPayPeriods));
            }

            // Calculates State Income Tax (simplified to bracket-based)
            getStateTax(annualGross, stateAbbr, filingStatus, stateTables, numPayPeriods) {
                const stateInfo = stateTables[stateAbbr];
                // Try to find filing status specific table, fallback to single if not found or empty
                const table = (stateInfo && stateInfo[filingStatus]) || (stateInfo && stateInfo.single);
                if (!table || table.brackets.length === 0) return 0; 
                const annualTax = this.calculateBracketTax(annualGross, table);
                return pMath.round(pMath.divide(annualTax, numPayPeriods));
            }

            // Calculates Social Security Tax, respecting annual limit
            getSocialSecurityTax(currentGross, ytdGross, ficaTable) {
                const limit = ficaTable.social_security_limit;
                // If YTD gross already exceeds limit, no more SS tax
                if (ytdGross >= limit) return 0;
                // Calculate remaining taxable income up to the limit
                const remainingTaxable = pMath.subtract(limit, ytdGross);
                // Taxable amount for this period is lesser of current gross or remaining taxable
                const taxableThisPeriod = Math.min(currentGross, remainingTaxable);
                return pMath.round(pMath.multiply(taxableThisPeriod, ficaTable.social_security_rate));
            }

            // Calculates Medicare Tax (no income limit)
            getMedicareTax(currentGross, ficaTable) {
                return pMath.round(pMath.multiply(currentGross, ficaTable.medicare_rate));
            }
        }
        BuellDocsApp.PaystubCalculator = PaystubCalculator;

        // --- PREVIEW UPDATER ---
        class PreviewUpdater {
            constructor() {
                this.container = document.getElementById('previews-container');
                this.template = document.getElementById('paystub-template');
                this.currentIndex = 0;
                this.totalStubs = 0;
            }

            // Updates all paystub previews based on calculation results
            updateAll(results) {
                this.container.innerHTML = ''; // Clear previous previews
                this.totalStubs = results.length;
                this.currentIndex = 0; // Reset to the first stub

                results.forEach((data, index) => {
                    const newStub = this.template.cloneNode(true);
                    newStub.id = `paystub-preview-${index}`;
                    newStub.classList.add('paystub-wrapper');
                    if (index === 0) newStub.classList.add('active'); // Activate the first stub by default
                    this.container.appendChild(newStub);
                    this.populateStub(newStub, data);
                });
                this.updateNav(); // Update navigation buttons and status
            }

            // Populates a single paystub preview with data
            populateStub(stubElement, data) {
                const find = (selector) => stubElement.querySelector(`[data-id="${selector}"]`);
                
                // Populate static information
                find('businessName').textContent = data.businessName;
                find('businessAddress').textContent = data.businessAddress;
                find('businessEin').textContent = `EIN: ${data.businessEin}`;
                find('employeeName').textContent = data.employeeName;
                find('employeeAddress').textContent = data.employeeAddress;
                find('employeeId').textContent = data.employeeId;
                find('employeeSsn').textContent = data.employeeSsn;
                find('payDate').textContent = formatDate(data.payDate);
                find('payPeriodRange').textContent = `${formatDate(data.payPeriodStart)} - ${formatDate(data.payPeriodEnd)}`;
                
                // Populate tables
                this.updateEarningsTable(find('earnings-table'), data.earnings, data.grossPay);
                this.updateGenericTable(find('deductions-table'), data.deductions, data.totalDeductions, "Total Deductions");
                this.updateGenericTable(find('taxes-table'), data.taxes, data.totalTaxes, "Total Taxes");
                
                // Populate summary section
                find('grossPay').textContent = formatCurrency(data.grossPay);
                find('totalDeductions').textContent = formatCurrency(data.totalDeductions);
                find('totalTaxes').textContent = formatCurrency(data.totalTaxes);

                find('summary-grossPay').textContent = formatCurrency(data.grossPay);
                find('summary-totalDeductions').textContent = formatCurrency(data.totalDeductions);
                find('summary-totalTaxes').textContent = formatCurrency(data.totalTaxes);
                find('summary-netPay').textContent = formatCurrency(data.netPay);
            }

            // Updates the earnings table with calculated values
            updateEarningsTable(table, items, total) {
                const tbody = table.querySelector('tbody');
                tbody.innerHTML = ''; // Clear existing rows
                 if (!items || items.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="5">None</td></tr>`;
                    return;
                }
                items.forEach(item => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${item.description}</td>
                            <td class="text-right">${formatCurrency(item.rate)}</td>
                            <td class="text-right">${item.hours.toFixed(2)}</td>
                            <td class="text-right">${formatCurrency(item.current)}</td>
                            <td class="text-right">${formatCurrency(item.ytd)}</td>
                        </tr>`;
                });
            }
            
            // Updates generic tables (deductions, taxes)
            updateGenericTable(table, items, total, totalLabel) {
                 const tbody = table.querySelector('tbody');
                tbody.innerHTML = ''; // Clear existing rows
                if (!items || items.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="3">None</td></tr>`;
                    return;
                }
                items.forEach(item => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${item.name || item.description}</td>
                            <td class="text-right">${formatCurrency(item.current)}</td>
                            <td class="text-right">${formatCurrency(item.ytd)}</td>
                        </tr>`;
                });
            }

            // Shows a specific paystub by index
            showStub(index) {
                if (index < 0 || index >= this.totalStubs) return; // Boundary check
                this.currentIndex = index;
                this.container.querySelectorAll('.paystub-wrapper').forEach((stub, i) => {
                    stub.classList.toggle('active', i === this.currentIndex); // Toggle active class
                });
                this.updateNav(); // Update navigation buttons
            }
            
            // Navigates to the next paystub
            next() { this.showStub(this.currentIndex + 1); }
            // Navigates to the previous paystub
            prev() { this.showStub(this.currentIndex - 1); }
            
            // Updates the navigation status text and button states
            updateNav() {
                document.getElementById('stub-nav-status').textContent = `Stub ${this.currentIndex + 1} of ${this.totalStubs}`;
                document.getElementById('prev-stub').disabled = this.currentIndex === 0;
                document.getElementById('next-stub').disabled = this.currentIndex >= this.totalStubs - 1;
            }

            // Gets the HTML content of the currently active paystub for PDF generation
            getCurrentStubHTML() {
                const activeStub = this.container.querySelector('.paystub-wrapper.active');
                return activeStub ? activeStub.innerHTML : "<div>No paystub selected.</div>";
            }
        }
        BuellDocsApp.PreviewUpdater = PreviewUpdater;

        // --- FORM MANAGER ---
        class FormManager {
            constructor(updateCallback) {
                this.form = document.getElementById('paystub-form');
                this.updateCallback = updateCallback;
                this.dataService = new BuellDocsApp.DataService();

                // Listen for input changes to trigger paystub recalculation
                this.form.addEventListener('input', (e) => {
                    if (e.target.id === 'incomeType' || e.target.id === 'incomeAmount' || e.target.id === 'payPeriod') {
                        this.handleIncomeCalculation(); // Recalculate income when relevant fields change
                    }
                    if (e.target.id === 'payPeriod' || e.target.id === 'numPaystubs') {
                        this.generateDateInputs(); // Regenerate dates if pay period or number of stubs changes
                    }
                    this.updateCallback(); // Trigger overall update
                });

                this.setupDynamicFields(); // Setup add/remove for earnings/deductions
                this.populateStateOptions(); // Populate state dropdown
                this.setupBatchGeneration(); // Setup dynamic date inputs for multiple stubs
                this.addDefaultEarningDeduction(); // Add initial earning/deduction rows
                this.handleIncomeCalculation(); // Initial income calculation
            }
            
            // Gathers all form data into a structured object
            getFormData() {
                // Helper to get values from dynamic fields (earnings or deductions)
                const getDynamicData = (containerId, hasRateAndHours) => {
                    const items = [];
                    const ytd = {};
                    // Select all dynamic field rows, excluding the header (which is also .dynamic-field-grid)
                    document.querySelectorAll(`#${containerId} .dynamic-field-grid`).forEach((field, index) => {
                        if (index === 0) return; // Skip the header row
                        const descInput = field.querySelector('[name*="Description"]');
                        if (!descInput) return; // Skip if description input is missing

                        const description = descInput.value;
                        let current = 0;
                        let ytdVal = 0;

                        if (hasRateAndHours) {
                            // For earnings, current is calculated from rate and hours
                            current = parseFloat(field.querySelector('[name*="AmountCurrent"]').value) || 0;
                            ytdVal = parseFloat(field.querySelector('[name*="AmountYTD"]').value) || 0;
                        } else {
                            // For deductions, current and YTD are direct inputs
                            current = parseFloat(field.querySelector('[name*="AmountCurrent"]').value) || 0;
                            ytdVal = parseFloat(field.querySelector('[name*="AmountYTD"]').value) || 0;
                        }
                        
                        if(description) { // Only add if description is not empty
                            const item = { description, current };
                            if(hasRateAndHours){
                                item.rate = parseFloat(field.querySelector('[name*="Rate"]').value) || 0;
                                item.hours = parseFloat(field.querySelector('[name*="Hours"]').value) || 0;
                            }
                            items.push(item);
                            ytd[description] = ytdVal; // Store YTD for this specific item description
                        }
                    });
                    return { items, ytd };
                };
                
                const earningsData = getDynamicData('earnings-container', true);
                const deductionsData = getDynamicData('deductions-container', false);

                // Collect paystub specific dates for batch generation
                const stubs = [];
                const numPaystubs = parseInt(document.getElementById('numPaystubs').value, 10);
                const payPeriod = document.getElementById('payPeriod').value;

                for(let i=0; i<numPaystubs; i++){
                    const payPeriodStart = document.getElementById(`payPeriodStart-${i}`).value;
                    const { payPeriodEnd, payDate } = this.calculateEndAndPayDates(payPeriodStart, payPeriod);
                    stubs.push({ payPeriodStart, payPeriodEnd, payDate });
                }

                return {
                    businessName: document.getElementById('businessName').value,
                    businessAddress: document.getElementById('businessAddress').value,
                    businessEin: document.getElementById('businessEin').value,
                    employeeName: document.getElementById('employeeName').value,
                    employeeAddress: document.getElementById('employeeAddress').value,
                    employeeId: document.getElementById('employeeId').value,
                    employeeSsn: document.getElementById('employeeSsn').value,
                    payPeriod: document.getElementById('payPeriod').value,
                    payRate: parseFloat(document.getElementById('payRate').value) || 0, // Not directly used in calculation, but good to keep
                    taxYear: document.getElementById('taxYear').value,
                    filingStatus: document.getElementById('filingStatus').value,
                    state: document.getElementById('state').value,
                    numPaystubs: numPaystubs,
                    stubs: stubs, // Contains start, end, and pay dates for each stub
                    earnings: earningsData.items,
                    deductions: deductionsData.items,
                    initialYtd: { // Initial YTD values from form input
                        earnings: earningsData.ytd,
                        deductions: deductionsData.ytd,
                        taxes: {} // Taxes YTD are purely calculated, not manually input here
                    }
                };
            }

            // Sets up listener for number of paystubs and generates date inputs
            setupBatchGeneration() {
                const numInput = document.getElementById('numPaystubs');
                numInput.addEventListener('input', () => this.generateDateInputs());
                this.generateDateInputs(); // Initial generation on load
            }

            // Dynamically generates date input fields based on number of paystubs selected
            generateDateInputs() {
                const container = document.getElementById('paystub-dates-container');
                const num = parseInt(document.getElementById('numPaystubs').value, 10) || 1;
                const payPeriod = document.getElementById('payPeriod').value;
                let daysToAdd = 0;
                switch (payPeriod) {
                    case 'weekly': daysToAdd = 7; break;
                    case 'bi-weekly': daysToAdd = 14; break;
                    // Semi-monthly and monthly are approximated for initial date display
                    case 'semi-monthly': daysToAdd = 15; break; 
                    case 'monthly': daysToAdd = 30; break;
                    default: daysToAdd = 14; // Default to bi-weekly
                }

                container.innerHTML = '';
                let lastStartDate = new Date();
                // Adjust the starting date for the first paystub to ensure a logical sequence for multiple stubs
                lastStartDate.setDate(lastStartDate.getDate() - (daysToAdd * (num > 1 ? num - 1 : 0)));

                for (let i = 0; i < num; i++) {
                    const div = document.createElement('div');
                    div.className = 'form-group';
                    div.innerHTML = `<label for="payPeriodStart-${i}">Paystub ${i + 1} Start Date</label>
                                     <input type="date" id="payPeriodStart-${i}" name="payPeriodStart-${i}">`;
                    container.appendChild(div);
                    // Set default date for the input
                    document.getElementById(`payPeriodStart-${i}`).value = lastStartDate.toISOString().split('T')[0];
                    lastStartDate.setDate(lastStartDate.getDate() + daysToAdd); // Advance for the next stub
                }
            }

            // Calculates the end date and pay date based on start date and pay frequency
            calculateEndAndPayDates(startDateString, payPeriod) {
                const startDate = new Date(startDateString + 'T00:00:00');
                const endDate = new Date(startDate);
                let payDate = new Date(startDate);
                
                switch(payPeriod) {
                    case 'weekly':
                        endDate.setDate(startDate.getDate() + 6); // 7 days in period
                        payDate = new Date(endDate);
                        payDate.setDate(endDate.getDate() + 5); // Pay 5 days after period end (typical)
                        break;
                    case 'bi-weekly':
                        endDate.setDate(startDate.getDate() + 13); // 14 days in period
                        payDate = new Date(endDate);
                        payDate.setDate(endDate.getDate() + 5); // Pay 5 days after period end
                        break;
                    case 'semi-monthly':
                        if (startDate.getDate() <= 15) {
                            endDate.setDate(15);
                        } else {
                            endDate.setMonth(endDate.getMonth() + 1);
                            endDate.setDate(0); // Last day of previous month (which is current month's last day)
                        }
                        payDate = new Date(endDate);
                        payDate.setDate(endDate.getDate() + 5);
                        break;
                    case 'monthly':
                        endDate.setMonth(endDate.getMonth() + 1);
                        endDate.setDate(0); // Last day of previous month (which is current month's last day)
                        payDate = new Date(endDate);
                        payDate.setDate(endDate.getDate() + 5);
                        break;
                    default: // Fallback to bi-weekly
                        endDate.setDate(startDate.getDate() + 13);
                        payDate = new Date(endDate);
                        payDate.setDate(endDate.getDate() + 5);
                        break;
                }
                return { 
                    payPeriodEnd: endDate.toISOString().split('T')[0],
                    payDate: payDate.toISOString().split('T')[0]
                };
            }

            // Handles calculation of pay rate/amount based on selected income type
            handleIncomeCalculation() {
                const incomeType = document.getElementById('incomeType').value;
                const incomeAmount = parseFloat(document.getElementById('incomeAmount').value) || 0;
                const incomeGroup = document.getElementById('income-amount-group');
                const payPeriod = document.getElementById('payPeriod').value;
                const payPeriodsPerYear = { weekly: 52, 'bi-weekly': 26, 'semi-monthly': 24, monthly: 12 };
                
                if (incomeType === 'manual' || incomeAmount <= 0) {
                    incomeGroup.style.display = 'none';
                    return;
                }
                
                incomeGroup.style.display = 'block';

                let annualSalary = 0;
                switch(incomeType) {
                    case 'annual': annualSalary = incomeAmount; break;
                    case 'monthly': annualSalary = incomeAmount * 12; break;
                    case 'weekly': annualSalary = incomeAmount * 52; break;
                    default: annualSalary = 0; break;
                }
                
                const grossPerPeriod = pMath.divide(annualSalary, payPeriodsPerYear[payPeriod]);
                // Typical working hours per period for a full-time employee (approximate for semi-monthly/monthly)
                const hoursPerPeriod = { weekly: 40, 'bi-weekly': 80, 'semi-monthly': 86.67, monthly: 173.33 }; 
                const hourlyRate = pMath.divide(grossPerPeriod, hoursPerPeriod[payPeriod]);
                
                // Update the first earning entry, assuming it's 'Regular Pay'
                // We target the second .dynamic-field-grid because the first is the header row
                const firstEarningRow = document.querySelector('#earnings-container .dynamic-field-grid:not(:first-child)'); 
                if (firstEarningRow) {
                    const descInput = firstEarningRow.querySelector('[name*="Description"]');
                    const rateInput = firstEarningRow.querySelector('[name*="Rate"]');
                    const hoursInput = firstEarningRow.querySelector('[name*="Hours"]');
                    
                    if (descInput && rateInput && hoursInput) {
                        descInput.value = 'Regular Pay'; // Ensure consistent label
                        rateInput.value = pMath.round(hourlyRate);
                        hoursInput.value = hoursPerPeriod[payPeriod].toFixed(2);
                        // The 'input' event listeners attached in addDynamicField for rate and hours
                        // will automatically trigger the calculation for 'AmountCurrent' and then
                        // call this.updateCallback(), leading to a full re-render.
                    }
                }

                // Update the 'Pay Rate' field in the Pay Details section
                document.getElementById('payRate').value = pMath.round(hourlyRate);
            }

            // Populates the state dropdown with names from tax data
            async populateStateOptions() {
                const stateSelect = document.getElementById('state');
                const states = this.dataService.getAllStateNames();
                for (const abbr in states) {
                    stateSelect.add(new Option(states[abbr], abbr));
                }
                stateSelect.value = 'NJ'; // Set default to New Jersey as requested
            }
            
            // Sets up event listeners for 'Add Earning' and 'Add Deduction' buttons
            setupDynamicFields() {
                document.getElementById('add-earning').addEventListener('click', () => {
                    this.addDynamicField('earnings-container', true);
                });
                document.getElementById('add-deduction').addEventListener('click', () => {
                    this.addDynamicField('deductions-container', false);
                });
            }

            // Adds default 'Regular Pay' earning and 'Health Insurance' deduction on load
            addDefaultEarningDeduction() {
                // Ensure default earnings are added after the header row (index 0)
                this.addDynamicField('earnings-container', true, { desc: 'Regular Pay', curr: 0, ytd: 0, rate: 31.25, hours: 80 }); // Current and YTD will be overridden by income calculator
                this.addDynamicField('deductions-container', false, { desc: 'Health Insurance', curr: 150, ytd: 3000 });
            }

            // Adds a new dynamic input field (for earnings or deductions)
            addDynamicField(containerId, hasRateAndHours, defaults = {}) {
                const container = document.getElementById(containerId);
                const newField = document.createElement('div');
                newField.className = 'form-group dynamic-field-grid';

                const desc = defaults.desc || '';
                const curr = defaults.curr || '';
                const ytd = defaults.ytd || '';
                const rate = defaults.rate || '';
                const hours = defaults.hours || '';
                
                const baseName = containerId.includes('earn') ? 'earning' : 'deduction';
                
                // HTML for input fields based on whether it's an earning (has rate/hours) or deduction
                newField.innerHTML = `
                    <input type="text" name="${baseName}Description" placeholder="Description" value="${desc}">
                    ${hasRateAndHours ? `
                        <input type="number" name="${baseName}Rate" placeholder="Rate" step="0.01" value="${rate}">
                        <input type="number" name="${baseName}Hours" placeholder="Hours" step="0.01" value="${hours}">
                        <input type="hidden" name="${baseName}AmountCurrent"> <!-- Hidden, calculated from Rate * Hours -->
                        <input type="number" name="${baseName}AmountYTD" placeholder="YTD" step="0.01" value="${ytd}">
                    ` : `
                        <input type="number" name="${baseName}AmountCurrent" placeholder="Amount" step="0.01" value="${curr}">
                        <input type="number" name="${baseName}AmountYTD" placeholder="YTD" step="0.01" value="${ytd}">
                        <span></span> <!-- Placeholder to align grid -->
                    `}
                    <button type="button" class="btn-remove">&times;</button>
                `;
                
                // If it's an earning field, set up listeners to calculate 'Current' amount
                if (hasRateAndHours) {
                    const rateInput = newField.querySelector('input[name*="Rate"]');
                    const hoursInput = newField.querySelector('input[name*="Hours"]');
                    const currentAmountInput = newField.querySelector('input[name*="AmountCurrent"]'); // This is now hidden
                    
                    const calculateCurrent = () => {
                         const currentAmount = pMath.multiply(parseFloat(rateInput.value) || 0, parseFloat(hoursInput.value) || 0);
                         currentAmountInput.value = pMath.round(currentAmount);
                         this.updateCallback(); // Trigger a full app update
                    };
                    rateInput.addEventListener('input', calculateCurrent);
                    hoursInput.addEventListener('input', calculateCurrent);
                    calculateCurrent(); // Initial calculation for the new row
                }

                container.appendChild(newField);
                // Add event listener for the remove button
                newField.querySelector('.btn-remove').addEventListener('click', (e) => {
                    e.target.parentElement.remove();
                    this.updateCallback(); // Trigger update after removal
                });
                // Add input listeners for all inputs in the new row to trigger updates
                newField.querySelectorAll('input').forEach(input => {
                    // Only add to non-hidden inputs, as hidden currentAmount is updated by rate/hours
                    if (input.type !== 'hidden') {
                        input.addEventListener('input', () => this.updateCallback());
                    }
                });
            }
        }
        BuellDocsApp.FormManager = FormManager;

        // --- UI CONTROLLER ---
        class UIController {
            constructor() {
                this.previewUpdater = new BuellDocsApp.PreviewUpdater();
                this.calculator = new BuellDocsApp.PaystubCalculator();
                // Pass the processUpdate method as a callback to FormManager
                this.formManager = new BuellDocsApp.FormManager(() => this.processUpdate());
                this.setupEventListeners();
                this.processUpdate(); // Initial calculation and render on page load
            }

            // Main method to fetch data, calculate, and update preview
            async processUpdate() {
                try {
                    const formData = this.formManager.getFormData();
                    const calculationResults = await this.calculator.calculateAll(formData);
                    this.previewUpdater.updateAll(calculationResults);
                } catch (error) {
                    console.error("Calculation Error:", error);
                    // Optionally display an error message to the user here
                }
            }

            // Sets up event listeners for global UI elements (e.g., PDF download, navigation)
            setupEventListeners() {
                document.getElementById('download-pdf').addEventListener('click', () => {
                    const currentStubHTML = this.previewUpdater.getCurrentStubHTML();
                    const element = document.createElement('div');
                    element.innerHTML = currentStubHTML; // Create a new element to avoid modifying the live preview DOM directly

                    const opt = {
                        margin: 0.5,
                        filename: 'paystub.pdf',
                        image: { type: 'jpeg', quality: 0.98 },
                        html2canvas: { scale: 2, useCORS: true }, // UseCORS might be needed for external images, though none are used here. Scale for better quality.
                        jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
                    };
                    html2pdf().from(element).set(opt).save();
                });

                document.getElementById('next-stub').addEventListener('click', () => this.previewUpdater.next());
                document.getElementById('prev-stub').addEventListener('click', () => this.previewUpdater.prev());
            }
        }
        BuellDocsApp.UIController = UIController;

        // --- APP INITIALIZATION ---
        // Initializes the main UIController once the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', () => {
            new BuellDocsApp.UIController();
        });
    })();
    </script>
</body>

</html>
